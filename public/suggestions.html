<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Suggestions â€” Agents of Chaos</title>
<link rel="stylesheet" href="style.css">
<style>
/* â”€â”€ Page layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body { background: var(--color-bg); color: var(--color-text); font-family: var(--font-body); margin: 0; padding: 0; }

.sugg-page { max-width: 52em; margin: 0 auto; padding: 2em 1.5em 4em; }

/* â”€â”€ Topbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sugg-topbar {
  display: flex; align-items: center; gap: 1.2em;
  padding: .6em 0 1.2em;
  border-bottom: 1px solid var(--color-rule);
  margin-bottom: 2em;
  flex-wrap: wrap;
}
.sugg-topbar-title { font-weight: bold; font-size: 1.05em; color: var(--color-accent); margin-right: auto; }
.sugg-topbar a { font-size: .88em; color: var(--color-link); text-decoration: none; }
.sugg-topbar a:hover { text-decoration: underline; }

/* â”€â”€ Intro â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sugg-intro { font-size: .92em; color: #555; line-height: 1.6; margin-bottom: 2em; padding: .9em 1.1em; background: #faf8f4; border-left: 3px solid var(--color-accent); border-radius: 0 4px 4px 0; }
.sugg-intro p { margin: 0 0 .5em; }
.sugg-intro p:last-child { margin: 0; }

/* â”€â”€ Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sugg-legend { display: flex; gap: 1.2em; font-size: .82em; margin-bottom: 1.8em; flex-wrap: wrap; }
.legend-item { display: flex; align-items: center; gap: .4em; }
.sev-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
.sev-dot.flag   { background: #c0392b; }
.sev-dot.minor  { background: #e67e22; }
.sev-dot.note   { background: #7f8c8d; }

/* â”€â”€ Suggestion card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sugg-card {
  border: 1px solid #ddd;
  border-radius: 6px;
  margin-bottom: 1.8em;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,.06);
}

.sugg-card-header {
  display: flex; align-items: center; gap: .7em;
  padding: .75em 1em;
  border-bottom: 1px solid #eee;
  background: #fafafa;
}
.sugg-card.flag  .sugg-card-header { background: #fff5f5; border-bottom-color: #fcc; }
.sugg-card.minor .sugg-card-header { background: #fffbf0; border-bottom-color: #fde8b8; }
.sugg-card.note  .sugg-card-header { background: #f8f8f8; border-bottom-color: #e8e8e8; }

.sugg-badge {
  font-size: .72em; font-weight: bold; padding: .15em .5em;
  border-radius: 3px; text-transform: uppercase; letter-spacing: .04em; white-space: nowrap;
}
.sugg-card.flag  .sugg-badge { background: #c0392b; color: #fff; }
.sugg-card.minor .sugg-badge { background: #e67e22; color: #fff; }
.sugg-card.note  .sugg-badge { background: #7f8c8d; color: #fff; }

.sugg-section-tag { font-size: .78em; color: #777; }
.sugg-title { font-weight: bold; font-size: .98em; color: #222; flex: 1; }

.sugg-body { padding: 1em 1.1em; }

.sugg-diff {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: .8em;
  margin-bottom: .9em;
}
@media (max-width: 600px) { .sugg-diff { grid-template-columns: 1fr; } }

.sugg-diff-pane { border-radius: 4px; padding: .7em .85em; font-size: .86em; line-height: 1.55; }
.sugg-diff-label { font-size: .72em; font-weight: bold; text-transform: uppercase; letter-spacing: .05em; margin-bottom: .35em; }

.diff-old { background: #fff0f0; border: 1px solid #f5c6c6; }
.diff-old .sugg-diff-label { color: #c0392b; }

.diff-new { background: #f0fff4; border: 1px solid #b2dfb8; }
.diff-new .sugg-diff-label { color: #27ae60; }

.sugg-evidence {
  font-size: .83em; color: #555; background: #f5f5f0;
  border-radius: 4px; padding: .6em .85em;
  margin-bottom: .8em; line-height: 1.5;
}
.sugg-evidence-label { font-weight: bold; color: #444; margin-bottom: .2em; font-size: .9em; }

.sugg-note {
  font-size: .82em; color: #7f8c8d; font-style: italic;
  padding: .4em .85em; border-left: 2px solid #ccc; margin-bottom: .6em;
}

.sugg-links { display: flex; gap: .6em; flex-wrap: wrap; margin-bottom: .8em; }
.sugg-link-btn {
  font-size: .8em; padding: .25em .7em; border-radius: 3px;
  background: #f0f0f0; border: 1px solid #ccc; color: #444;
  text-decoration: none; cursor: pointer;
}
.sugg-link-btn:hover { background: #e8e8e8; }
.sugg-link-btn.github { background: #24292e; color: #fff; border-color: #24292e; }
.sugg-link-btn.github:hover { background: #444d56; }

.sugg-actions { display: flex; align-items: center; gap: .8em; padding-top: .5em; border-top: 1px solid #eee; margin-top: .4em; flex-wrap: wrap; }

.discuss-btn {
  display: inline-flex; align-items: center; gap: .4em;
  padding: .35em .9em; border-radius: 4px;
  background: #24292e; color: #fff; border: none;
  font-size: .84em; font-family: inherit; cursor: pointer; text-decoration: none;
}
.discuss-btn:hover { background: #444d56; }

.vote-hint { font-size: .78em; color: #888; }

.status-tag {
  font-size: .73em; padding: .15em .5em; border-radius: 3px;
  font-weight: bold; text-transform: uppercase; letter-spacing: .04em; margin-left: auto;
}
.status-pending  { background: #eee; color: #666; }
.status-accepted { background: #d4edda; color: #155724; }
.status-rejected { background: #f8d7da; color: #721c24; }
.status-wontfix  { background: #e8e8e8; color: #888; }

/* â”€â”€ No-issue placeholder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.no-issue-note { font-size: .78em; color: #aaa; font-style: italic; }

/* â”€â”€ Summary bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sugg-summary { font-size: .85em; color: #666; margin-bottom: 1.5em; }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-title">Agents of Chaos â€” Suggestions</div>
  <div class="topbar-links">
    <a href="report.html">Report</a>
    <a href="index.html">Landing Page</a>
    <a href="logs.html">Discord</a>
    <a href="sessions.html">Sessions</a>
    <a href="dashboard.html">Dashboard</a>
  </div>
</div>

<div class="sugg-page">

  <div class="sugg-intro">
    <p>This page collects proposed corrections to <em>Agents of Chaos</em> identified during log-based proofreading. Each suggestion is backed by specific evidence from Discord or OpenClaw session logs.</p>
    <p>To discuss or vote on a suggestion, click <strong>Discuss on GitHub</strong> â€” GitHub's built-in ğŸ‘/ğŸ‘ reactions serve as votes. Comments welcome from any co-author or reviewer.</p>
  </div>

  <div class="sugg-legend">
    <span class="legend-item"><span class="sev-dot flag"></span> Factual flag â€” paper claim contradicted by logs</span>
    <span class="legend-item"><span class="sev-dot minor"></span> Minor wording â€” small imprecision, meaning preserved</span>
    <span class="legend-item"><span class="sev-dot note"></span> Pending â€” awaiting author confirmation</span>
  </div>

  <div class="sugg-summary" id="sugg-summary">Loadingâ€¦</div>
  <div id="sugg-list"></div>
</div>

<script>
const SESSIONS_BASE = 'sessions.html';
const GITHUB_REPO = 'wendlerc/betrayal-edits';

function esc(s) {
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function severityClass(s) {
  if (s === 'flag') return 'flag';
  if (s === 'minor') return 'minor';
  return 'note';
}

function severityLabel(s) {
  if (s === 'flag') return 'Factual flag';
  if (s === 'minor') return 'Minor wording';
  return 'Pending';
}

function statusClass(s) {
  return 'status-' + (s || 'pending');
}

function statusLabel(s) {
  const map = {pending: 'Pending', accepted: 'Accepted', rejected: 'Rejected', wontfix: 'Won\'t fix'};
  return map[s] || s || 'Pending';
}

function renderEvidenceLinks(links) {
  if (!links || !links.length) return '';
  return links.map(l => {
    if (l.session_id) {
      const turnSuffix = l.turn ? `/${l.turn}` : '';
      const url = `sessions.html#sess-${esc(l.session_id)}${turnSuffix}`;
      return `<a class="sugg-link-btn" href="${url}" target="_blank">ğŸ¤– ${esc(l.label)}</a>`;
    }
    if (l.discord_msg_id) {
      const url = `logs.html#msg-${esc(l.discord_msg_id)}`;
      return `<a class="sugg-link-btn" href="${url}" target="_blank">ğŸ’¬ ${esc(l.label)}</a>`;
    }
    if (l.url) {
      const icon = l.url.startsWith('logs.html') ? 'ğŸ’¬' : (l.url.startsWith('sessions.html') ? 'ğŸ¤–' : 'ğŸ”—');
      return `<a class="sugg-link-btn" href="${esc(l.url)}" target="_blank">${icon} ${esc(l.label)}</a>`;
    }
    return `<span class="sugg-link-btn">${esc(l.label)}</span>`;
  }).join('');
}

function githubIssueUrl(sugg) {
  if (sugg.github_issue) {
    return `https://github.com/${GITHUB_REPO}/issues/${sugg.github_issue}`;
  }

  // Absolute base URL for the website (strip filename + hash)
  const base = window.location.href.replace(/\/[^/]*$/, '');
  const suggPageUrl = `${base}/suggestions.html#sugg-${sugg.id}`;

  // Format evidence links as markdown
  let evidenceLinksBlock = '';
  if (sugg.evidence_links && sugg.evidence_links.length) {
    const lines = sugg.evidence_links.map(l => {
      if (l.session_id) {
        const turnSuffix = l.turn ? `/${l.turn}` : '';
        return `- ğŸ¤– [${l.label}](${base}/sessions.html#sess-${l.session_id}${turnSuffix})`;
      }
      if (l.discord_msg_id) {
        return `- ğŸ’¬ [${l.label}](${base}/logs.html#msg-${l.discord_msg_id})`;
      }
      if (l.url) {
        const fullUrl = l.url.startsWith('http') ? l.url : `${base}/${l.url}`;
        return `- ğŸ”— [${l.label}](${fullUrl})`;
      }
      return `- ${l.label}`;
    });
    evidenceLinksBlock = '\n\n**Log materials:**\n' + lines.join('\n');
  }

  const title = encodeURIComponent(`[Edit suggestion] ${sugg.id}: ${sugg.title}`);
  const body = encodeURIComponent(
    `**Section:** ${sugg.section}\n\n` +
    `**Paper text:**\n> ${sugg.paper_text}\n\n` +
    `**Suggested correction:**\n> ${sugg.suggested_text}\n\n` +
    `**Evidence:**\n${sugg.evidence_summary || ''}` +
    evidenceLinksBlock + '\n\n' +
    `**â†’ View suggestion entry:** ${suggPageUrl}\n\n` +
    `_Auto-generated from suggestions.json â€” use ğŸ‘/ğŸ‘ to vote_`
  );
  return `https://github.com/${GITHUB_REPO}/issues/new?title=${title}&body=${body}&labels=edit-suggestion`;
}

function renderCard(sugg) {
  const sev = severityClass(sugg.severity);
  const issueUrl = githubIssueUrl(sugg);
  const hasIssue = !!sugg.github_issue;

  return `
<div class="sugg-card ${sev}" id="sugg-${esc(sugg.id)}">
  <div class="sugg-card-header">
    <span class="sugg-badge">${esc(severityLabel(sugg.severity))}</span>
    <span class="sugg-section-tag">${esc(sugg.section)}</span>
    <span class="sugg-title">${esc(sugg.title)}</span>
  </div>
  <div class="sugg-body">
    <div class="sugg-diff">
      <div class="sugg-diff-pane diff-old">
        <div class="sugg-diff-label">Paper currently says</div>
        <div>${esc(sugg.paper_text)}</div>
      </div>
      <div class="sugg-diff-pane diff-new">
        <div class="sugg-diff-label">Suggested correction</div>
        <div>${esc(sugg.suggested_text)}</div>
      </div>
    </div>
    ${sugg.evidence_summary ? `
    <div class="sugg-evidence">
      <div class="sugg-evidence-label">Evidence</div>
      ${esc(sugg.evidence_summary)}
    </div>` : ''}
    ${sugg.note ? `<div class="sugg-note">â„¹ï¸ ${esc(sugg.note)}</div>` : ''}
    ${sugg.evidence_links && sugg.evidence_links.length ? `
    <div class="sugg-links">
      ${renderEvidenceLinks(sugg.evidence_links)}
    </div>` : ''}
    <div class="sugg-actions">
      <a class="discuss-btn" href="${esc(issueUrl)}" target="_blank" rel="noopener">
        ${hasIssue ? 'ğŸ’¬ Discuss on GitHub' : 'ğŸ’¬ Open discussion on GitHub'}
      </a>
      ${hasIssue
        ? `<span class="vote-hint">ğŸ‘ / ğŸ‘ reactions on the issue = votes</span>`
        : `<span class="vote-hint no-issue-note">Will create a GitHub issue â€” repo must be public</span>`}
      <span class="status-tag ${statusClass(sugg.status)}">${esc(statusLabel(sugg.status))}</span>
    </div>
  </div>
</div>`;
}

fetch('data/suggestions.json')
  .then(r => r.json())
  .then(data => {
    const flags = data.filter(s => s.severity === 'flag').length;
    const minors = data.filter(s => s.severity === 'minor').length;
    document.getElementById('sugg-summary').textContent =
      `${data.length} suggestion${data.length !== 1 ? 's' : ''} â€” ${flags} factual flag${flags !== 1 ? 's' : ''}, ${minors} minor wording`;
    document.getElementById('sugg-list').innerHTML = data.map(renderCard).join('');
  })
  .catch(e => {
    document.getElementById('sugg-summary').textContent = 'Error loading suggestions.';
    document.getElementById('sugg-list').innerHTML = `<p style="color:red">${esc(String(e))}</p>`;
  });
</script>
</body>
</html>
